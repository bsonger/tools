apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: devflow-ci
  namespace: tekton-pipelines
spec:
  params:
    - name: manifest-id
      type: string
    - {name: git-url,        type: string}
    - {name: git-revision,   type: string,  default: main}
    - {name: image-registry, type: string}
    - {name: name,           type: string}
    - {name: image-tag,      type: string,  default: latest}
    - {name: DOCKERFILE,      type: string,  default: Dockerfile}
    - name: manifest-name
      type: string
  workspaces:
    - {name: source}
    - {name: dockerconfig}
    - name: ssh
  tasks:
    - name: clone
      taskRef: {name: git-clone-ssh}
      params:
        - {name: url,      value: $(params.git-url)}
        - {name: revision, value: $(params.git-revision)}
      workspaces:
        - {name: output, workspace: source}
        - name: ssh
          workspace: ssh

    - name: build-image
      runAfter: [clone]
      taskRef: {name: build-and-push-image}
      params:
        - name: IMAGE
          value: $(params.image-registry)/$(params.name):$(params.image-tag)
        - name: DOCKERFILE
          value: $(params.DOCKERFILE)
      workspaces:
        - {name: source,       workspace: source}
        - {name: dockerconfig, workspace: dockerconfig}

    - name: patch-manifest
      runAfter: ["build-image"]
      taskRef:
        name: devflow-patch
      params:
        - name: manifest-id
          value: $(params.manifest-id)

        - name: commit-hash
          value: $(tasks.clone.results.commit)

        - name: image-digest
          value: $(tasks.build-image.results.IMAGE_DIGEST)

    - name: trivy-scan
      runAfter:
        - build-image
      taskRef:
        name: trivy-scan
      params:
        - name: IMAGE
          value: $(params.image-registry)/$(params.name):$(params.image-tag)
      workspaces:
        - name: dockerconfig
          workspace: dockerconfig
  finally:
    - name: notify
      taskRef: {name: notify}
      params:
        - {name: message, value: "ðŸŽ‰ Pipeline $(context.pipelineRun.name) finished."}