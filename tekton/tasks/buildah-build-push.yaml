apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: buildah-build-push
  namespace: tekton-pipelines
spec:
  description: ä½¿ç”¨ Buildah æ„å»ºå¹¶æ¨é€é•œåƒåˆ° Harborï¼ˆä½¿ç”¨ harbor-auth secretï¼‰
  params:
    - name: IMAGE
      description: ç›®æ ‡é•œåƒï¼ˆä¾‹å¦‚ registry.cn-hangzhou.aliyuncs.com/project/image:tagï¼‰
      type: string
    - name: DOCKERFILE
      description: Dockerfile æ–‡ä»¶åï¼ˆé»˜è®¤ï¼šDockerfileï¼‰
      type: string
      default: Dockerfile
    - name: CONTEXT
      description: Build context è·¯å¾„ï¼ˆé»˜è®¤ï¼š.ï¼‰
      type: string
      default: .
  workspaces:
    - name: source
      description: æºä»£ç ç›®å½•ï¼ˆåŒ…å« Dockerfileï¼‰
    - name: dockerconfig
      description: Harbor ç™»å½• Secretï¼ˆåº”ä¸ºåŒ…å« config.json çš„ Secretï¼‰
      mountPath: /kaniko/.docker/   # Tekton è‡ªåŠ¨æŒ‚è½½è¿™ä¸ª workspace åˆ°è¯¥è·¯å¾„
  steps:
    - name: check-docker-config
      image: alpine
      imagePullPolicy: IfNotPresent
      script: |
        echo "ğŸ” /kaniko/.docker ç›®å½•å†…å®¹:"
        ls -al /kaniko/.docker
        echo "ğŸ“„ .dockerconfigjson å†…å®¹:"
        cat /kaniko/.docker/.dockerconfigjson || echo "âŒ .dockerconfigjson ä¸å­˜åœ¨"
        ls -lh $(workspaces.source.path)

    - name: build
      image: quay.io/buildah/stable:latest
      imagePullPolicy: IfNotPresent
      securityContext:
        privileged: true
      env:
        - name: REGISTRY_AUTH_FILE
          value: /kaniko/.docker/.dockerconfigjson  # Buildah è¯»å–è¿™ä¸ªæ–‡ä»¶è¿›è¡Œè®¤è¯
        - name: HTTP_PROXY
          value: http://192.168.1.2:7890
        - name: HTTPS_PROXY
          value: http://192.168.1.2:7890
        - name: NO_PROXY
          value: localhost,127.0.0.1,.svc,.cluster.local
      script: |
        #!/bin/sh
        set -e
        echo "ğŸ”§ æ„å»ºé•œåƒ: $(params.IMAGE)"
        buildah bud --pull=missing -f $(workspaces.source.path)/$(params.DOCKERFILE) \
                    -t $(params.IMAGE) \
                    $(workspaces.source.path)
        buildah push $(params.IMAGE)
